(function(c,n){typeof exports=="object"&&typeof module<"u"?n(exports,require("react"),require("react-dom")):typeof define=="function"&&define.amd?define(["exports","react","react-dom"],n):(c=typeof globalThis<"u"?globalThis:c||self,n(c["safe-form"]={},c.React,c.ReactDOM))})(this,function(c,n,R){"use strict";class S extends Error{constructor(o){super(o),this.message=o}}const E=t=>t.flatten().fieldErrors,T=t=>{var o;return t.type==="checkbox"?t.checked:t.type==="number"?parseFloat(t.value):t.type==="file"?t.files??null:t.type==="radio"?t.checked?t.value:null:t.type==="date"?((o=t.valueAsDate)==null?void 0:o.toISOString())??null:t.value},w=({action:t,schema:o,initialState:g,initialValues:A,validateOnBlur:d,validateOnChange:a})=>{const r=n.useRef(null),[C,j]=n.useTransition(),[i,v]=R.useFormState(t,g??null),[I,f]=n.useState({}),[l,h]=n.useState(A??{}),p=n.useCallback(()=>{if(!r.current)return l;let e=l;if(r.current){console.log(r.current);for(const[s,u]of Object.entries(r.current))u!=null&&u.current&&(e[s]=T(u.current));h({...l,...e})}return e},[r,l]),P=n.useCallback(()=>{if(!o)return!0;const e=p(),s=o.safeParse(e);return s.success?(f({}),!0):(f(E(s.error)),!1)},[f,o,r,p]),O=n.useCallback(e=>l[e],[l]),m=n.useCallback((e,s)=>{h(u=>({...u,[e]:s}))},[r,h]),F=n.useCallback(e=>{var b,y;if(!o)return!0;let s=l[e];(y=(b=r.current)==null?void 0:b[e])!=null&&y.current&&(s=T(r.current[e].current));const u=o.safeParse({[e]:s});if(!u.success){const k=E(u.error)[e];if(k)return f(M=>({...M,[e]:k})),!1}return f(k=>({...k,[e]:void 0})),!0},[f,o,r,p]),q=n.useCallback(()=>({onSubmit:e=>{e.preventDefault(),f({});let s=!1;if(R.flushSync(()=>{s=P()}),!s)return;console.log(l);const u=new FormData;for(const[b,y]of Object.entries(l))u.append(b,y);j(async()=>{await v(u)})},action:v}),[l,P,f,v,j,v]),x=n.useCallback(e=>(r.current===null&&(r.current={}),r.current[e]=n.createRef(),console.log(e,r.current),{ref:r.current[e],name:e.toString(),onBlur:d?()=>F(e):void 0,onChange:a?()=>F(e):void 0}),[r,F,d,a]);return{error:(i==null?void 0:i.error)??null,response:(i==null?void 0:i.response)??null,fieldErrors:(i==null?void 0:i.fieldErrors)??I??{},isPending:C,getAll:p,validateAll:P,getField:O,setField:m,validateField:F,connect:q,bindField:x}},D=(t,o)=>async(g,A)=>{const d={};for(const[r,C]of Array.from(A.entries()))d[r]=C;const a=t.safeParse(d);if(!a.success)return{fieldErrors:E(a.error)};try{return{response:await o(a.data,g)}}catch(r){if(r instanceof S)return{error:r.message};throw r}};c.FormActionError=S,c.createFormAction=D,c.useForm=w,Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});
