(function(a,s){typeof exports=="object"&&typeof module<"u"?s(exports,require("react"),require("react-dom")):typeof define=="function"&&define.amd?define(["exports","react","react-dom"],s):(a=typeof globalThis<"u"?globalThis:a||self,s(a["safe-form"]={},a.React,a.ReactDOM))})(this,function(a,s,O){"use strict";class R extends Error{}const k=e=>e.flatten().fieldErrors,j="__safe-form-scalars",L=e=>{const t=new FormData;let u={};for(const[l,f]of Object.entries(e)){if(f instanceof File){t.append(l,f);continue}u[l]=f}return t.append(j,JSON.stringify(u)),t},M=e=>{const t={};for(const[u,l]of Array.from(e.entries())){if(u===j){const f=JSON.parse(l);for(const[p,d]of Object.entries(f))t[p]=d;continue}t[u]=l}return t},w=e=>{var t,u;if(e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement)return e.value;if(e.type==="checkbox")return e.checked;if(e.type==="number"){const l=parseFloat(e.value||"0");return isNaN(l)?null:l}return e.type==="file"?((t=e.files)==null?void 0:t[0])??null:e.type==="radio"?e.checked?e.value:null:e.type==="date"?((u=e.valueAsDate)==null?void 0:u.toISOString())??null:e.value},N=({action:e,schema:t,initialState:u,initialValues:l,validateOnBlur:f,validateOnChange:p,onSubmit:d,onSuccess:C,onError:D})=>{const o=s.useRef(null),[x,P]=s.useTransition(),[r,y]=O.useFormState(e,u??null),[m,F]=s.useState({}),[v,T]=s.useState(l??{}),b=s.useCallback(()=>{if(!o.current)return v;let n=v;for(const[i,c]of Object.entries(o.current))c!=null&&c.current&&(n[i]=w(c.current));return T({...v,...n}),n},[o,v]),g=s.useCallback(()=>{const n=b();if(!t)return!0;const i=t.safeParse(n);return i.success?(F({}),!0):(F(k(i.error)),!1)},[F,t,o,b]),q=s.useCallback(n=>v[n],[v]),H=s.useCallback((n,i)=>{T(c=>({...c,[n]:i}))},[o,T]),A=s.useCallback(n=>{var h,I;if(!t)return!0;let i=v[n];(I=(h=o.current)==null?void 0:h[n])!=null&&I.current&&(i=w(o.current[n].current));const c=t.safeParse({[n]:i});if(!c.success){const E=k(c.error)[n];if(E)return F(Z=>({...Z,[n]:E})),!1}return F(E=>({...E,[n]:void 0})),!0},[F,t,o,b]),J=s.useCallback(()=>({onSubmit:async n=>{if(n.preventDefault(),F({}),d&&!await d(b()))return;let i=!1;if(O.flushSync(()=>{i=g()}),!i)return;const c=L(v);P(async()=>{await y(c)})},action:y}),[v,g,F,y,P,y]),V=s.useCallback(n=>(o.current===null&&(o.current={}),o.current[n]=s.createRef(),{ref:o.current[n],name:n.toString(),onBlur:f?()=>A(n):void 0,onChange:p?()=>A(n):void 0}),[o,A,f,p]);return s.useEffect(()=>{(r!=null&&r.error||r!=null&&r.fieldErrors)&&(D==null||D((r==null?void 0:r.error)??null,(r==null?void 0:r.fieldErrors)??null)),r!=null&&r.response&&(C==null||C(r.response))},[r]),{error:(r==null?void 0:r.error)??null,response:(r==null?void 0:r.response)??null,fieldErrors:(r==null?void 0:r.fieldErrors)??m??{},isPending:x,getAll:b,validateAll:g,getField:q,setField:H,validateField:A,connect:J,bindField:V}},_=(e,t)=>async(u,l)=>{const f=M(l),p=e.safeParse(f);if(!p.success)return{fieldErrors:k(p.error)};try{return{response:await t(p.data,u)}}catch(d){if(d instanceof R)return{error:d.message};throw d}};a.FormActionError=R,a.createFormAction=_,a.useForm=N,Object.defineProperty(a,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=safe-form.umd.js.map
